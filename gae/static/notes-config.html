<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
		<link rel="stylesheet" href="//code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.css"/>
		<script src="//code.jquery.com/jquery-1.9.1.min.js"></script>
		<script src="//code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.js"></script>
		<script src="common.js"></script>
		<title>PebbleTasks Configuration</title>
	</head>
	<body>
		<div data-role="page" id="page1">
			<div data-theme="" data-role="header">
				<h1>PebbleTasks</h1>
			</div>
			<div data-role="content">
				<h2>Account</h2>
				<input type="hidden" id="access_token"/>
				<button data-theme="b" id="btn-login">Log in</button>
				<button data-theme="c" id="btn-logout">Log out</button>

				<hr/>

				<h2>Options</h2>
				<div data-role="fieldcontain" data-option="sort_status">
					<label for="sort_status">Move completed tasks to the end of list</label>
					<select name="sort_status" id="sort_status" data-theme="" data-role="slider">
						<option value="off">Off</option>
						<option value="on">On</option>
					</select>
				</div>
				<div data-role="fieldcontain" data-option="sort_due">
					<fieldset id="sort_due" data-theme="" data-role="controlgroup" data-type="horizontal">
						<legend>Sort tasks by due date <small>(will move tasks without due date to the end of list)</small></legend>
						<label>
							<input type="radio" name="sort_due" id="sort_due_off" value="off" checked="checked"/>
							Off
						</label>
						<label>
							<input type="radio" name="sort_due" id="sort_due_asc" value="asc"/>
							Nearest first
						</label>
						<label>
							<input type="radio" name="sort_due" id="sort_due_desc" value="desc"/>
							Latest first
						</label>
					</fieldset>
				</div>
				<div data-role="fieldcontain" data-option="sort_date">
					<fieldset id="sort_date" data-theme="" data-role="controlgroup" data-type="horizontal">
						<legend>Sort tasks by date updated</legend>
						<label>
							<input type="radio" name="sort_date" id="sort_date_off" value="off" checked="checked"/>
							Off
						</label>
						<label>
							<input type="radio" name="sort_date" id="sort_date_asc" value="asc"/>
							Oldest first
						</label>
						<label>
							<input type="radio" name="sort_date" id="sort_date_desc" value="desc"/>
							Newest first
						</label>
					</fieldset>
				</div>
				<div data-role="fieldcontain" data-option="sort_alpha">
					<label for="sort_alpha">Sort tasks alphabetically <small>(ignore user-selected order)</small></label>
					<select name="sort_alpha" id="sort_alpha" data-theme="" data-role="slider">
						<option value="off">Off</option>
						<option value="on">On</option>
					</select>
				</div>

				<hr/>
				<div data-role="fieldcontain" data-option="large_font">
					<label for="large_font">Use larger font when displaying tasks</label>
					<select name="large_font" id="large_font" data-theme="" data-role="slider">
						<option value="off">Off</option>
						<option value="on">On</option>
					</select>
				</div>
				<div data-role="fieldcontain" data-option="task_actions_position">
					<fieldset id="task_actions_position" data-theme="" data-role="controlgroup" data-type="horizontal">
						<legend>Task actions position</legend>
						<label>
							<input type="radio" name="task_actions_position" id="task_actions_position_none" value="0" checked="checked"/>
							None
						</label>
						<label>
							<input type="radio" name="task_actions_position" id="task_actions_position_top" value="1"/>
							Top
						</label>
						<label>
							<input type="radio" name="task_actions_position" id="task_actions_position_bottom" value="2"/>
							Bottom
						</label>
					</fieldset>
				</div>

				<div class="ui-body ui-body-b">
					<fieldset class="ui-grid-a">
						<div class="ui-block-a"><button type="submit" data-theme="a" id="btn-submit">Save</button></div>
						<div class="ui-block-b"><button type="submit" data-theme="d" id="btn-cancel">Cancel</button></div>
					</fieldset>
				</div>
			</div>
		</div>
		<script>
			var opts = {}
			function updateControls() {
				try {
					opts = JSON.parse(decodeURIComponent(window.location.hash.substring(1)));
					// fix boolean values
					substitutions = {
						'true': true,
						'false': false,
					};
					$.each(opts, function(k, v) {
						if(typeof substitutions[v] != 'undefined')
							opts[k] = substitutions[v];
					});
					// now we want to hide all option divs by default
					// and show only those which have values provided by watch
					// thus we will not show unsupported options
					$('[data-option]').hide();
					$.each(opts, function(k) {
						$('[data-option='+k+']').show();
					});
				} catch(e) {
					alert('Error parsing options: '+e);
					console.log(e);
				}
				console.log(opts);
				$("#sort_status").val(opts.sort_status?'on':'off').slider("refresh");
				$("#sort_due input[type=radio][value="+opts.sort_due+"]").prop('checked', true);
				$("#sort_date input[type=radio][value="+opts.sort_date+"]").prop('checked', true);
				$("#sort_alpha").val(opts.sort_alpha?'on':'off').slider("refresh");
				$("#access_token").val(opts.access_token);
				$('#large_font').val(opts.large_font?'on':'off').slider('refresh');
				$('#task_actions_position input[type=radio][value='+opts.task_actions_position+']').prop('checked', true);
				// and update displayed radiobutton states...
				$('fieldset input[type=radio]').checkboxradio('refresh');
				if(opts.access_token) { // TODO: check token validity
			//		$("#btn-login").hide();
				} else {
			//		$("#btn-logout").hide();
				}
			}

			function saveOptions() {
				var options = {};
				$('[data-option]:visible').each(function() {
					var $this = $(this);
					var key = $this.data('option');
					var $sel = $(this).find('select');
					if($sel.length) {
						options[key] = $sel.val();
					} else {
						options[key ] $this.find(':checked').val();
					}
				});
				return options;
			}

			/** Log into Google account
			 */
			function doLogin() {
				window.location = "auth?" + $.param({
						response_type: "code",
						scope: "https://www.googleapis.com/auth/tasks",
						state: "",
						access_type: "offline",
						approval_prompt: "force", // If user tries to authenticate then we have no valid refresh tokens.
						include_granted_scopes: "true",
				});
			}
			/** Invalidate and forget login credentials
			 */
			function doLogout() {
				$.ajax({
						dataType: "json",
						url: "https://accounts.google.com/o/oauth2/revoke",
						data: {token: $("#access_token").val()},
						success: function(answer) {
							alert("Logged out. "+opts.access_token);
							closeConfig({logout:true});
						},
						error: function() {
							alert("Error. Dropping credentials. "+opts.access_token);
							closeConfig({logout:true});
						},
				});
			}

			$().ready(function() {
				$("#btn-cancel").click(function() {
					console.log("Cancel");
					closeConfig();
				});

				$("#btn-submit").click(function() {
					console.log("Submit");

					closeConfig(saveOptions());
				});

				$("#btn-login").click(function() {
					console.log("Login");
					doLogin();
				});
				$("#btn-logout").click(function() {
					console.log("Logout");
					doLogout();
				});
			});

			$('#page1').bind('pageinit', updateControls);
		</script>
	</body>
</html>
